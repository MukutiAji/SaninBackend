#!/data/data/com.termux/files/usr/bin/bash

PROJECT_DIR="$HOME/sanin-backend"
GITHUB_URL="https://raw.githubusercontent.com/MukutiAji/SaninBackend/main/sanin"
SCRIPT_PATH="$PREFIX/bin/sanin"

# ==== ğŸ¨ WARNA RANDOM CERAH
COLORS=(32 33 34 35 36 91 92 93 94 95 96) # hijau kuning biru pink cyan dll
RANDOM_COLOR=${COLORS[$RANDOM % ${#COLORS[@]}]}

# ==== ğŸ”¤ FUNGSI CETAK BERWARNA
cetak() {
  echo -e "\e[1;${RANDOM_COLOR}m$1\e[0m"
}

print_output() {
  while IFS= read -r line; do
    echo -e "\e[1;${RANDOM_COLOR}m$line\e[0m"
  done
}

# ==== ğŸ­ ASCII ART OPENING + CEK TOOLS
ascii_art() {
  clear

  # Tampilkan ascii pembuka
  echo
  cetak "â•­â”â”â”â”³â”â”â”â”³â”â•®â•±â•­â”³â”â”â”³â”â•®â•±â•­â•®"
  cetak "â”ƒâ•­â”â•®â”ƒâ•­â”â•®â”ƒâ”ƒâ•°â•®â”ƒâ”£â”«â”£â”«â”ƒâ•°â•®â”ƒâ”ƒ"
  cetak "â”ƒâ•°â”â”â”«â”ƒâ•±â”ƒâ”ƒâ•­â•®â•°â•¯â”ƒâ”ƒâ”ƒâ”ƒâ•­â•®â•°â•¯â”ƒ"
  cetak "â•°â”â”â•®â”ƒâ•°â”â•¯â”ƒâ”ƒâ•°â•®â”ƒâ”ƒâ”ƒâ”ƒâ”ƒâ”ƒâ•°â•®â”ƒâ”ƒ"
  cetak "â”ƒâ•°â”â•¯â”ƒâ•­â”â•®â”ƒâ”ƒâ•±â”ƒâ”ƒâ”£â”«â”£â”«â”ƒâ•±â”ƒâ”ƒâ”ƒ"
  cetak "â•°â”â”â”â”»â•¯â•±â•°â”»â•¯â•±â•°â”â”»â”â”â”»â•¯â•±â•°â”â•¯"
  sleep 1

  cetak "ğŸ” Cek awal dependensi (nala, figlet, boxes)..."

  # Cek dan install nala, figlet, boxes
  if ! command -v nala &>/dev/null; then
    cetak "[ğŸ“¥] Menginstall nala..."
    apt-get install nala -y | print_output
  else
    cetak "[ğŸ“¦] nala sudah terinstall"
  fi

  if ! command -v figlet &>/dev/null; then
    cetak "[ğŸ“¥] Menginstall figlet..."
    apt-get install figlet -y | print_output
  else
    cetak "[âœ…] figlet sudah terinstall"
  fi

  if ! command -v boxes &>/dev/null; then
    cetak "[ğŸ“¥] Menginstall boxes..."
    apt-get install boxes -y | print_output
  else
    cetak "[âœ…] boxes sudah terinstall"
  fi

  sleep 2

  clear
}

# ==== ğŸ“¦ CEK & INSTALL PAKET
pkg_install() {
  if command -v nala &>/dev/null; then
    cetak "[ğŸ“¦] Menggunakan nala..."
    for pkg in "$@"; do
      if ! dpkg -s $pkg &>/dev/null; then
        nala install -y $pkg | print_output
      else
        cetak "[âœ…] $pkg sudah terinstall"
      fi
    done
  else
    for pkg in "$@"; do
      if ! command -v $pkg &>/dev/null; then
        pkg install $pkg -y | print_output
      else
        cetak "[âœ…] $pkg sudah terinstall"
      fi
    done
  fi
}

# ==== ğŸ¨ BANNER SANIN
show_banner() {
  clear
  echo

  # Tampilkan figlet tanpa kode ANSI bocor
  figlet -w 100 "SANIN WA" | while IFS= read -r line; do
    # Hapus ANSI escape code dari figlet (kalau ada)
    clean_line=$(echo -e "$line" | sed 's/\x1b\[[0-9;]*m//g')
    cetak "$clean_line"
  done

  echo "By: Mukticuy" | boxes -d stone | while IFS= read -r line; do
    clean_line=$(echo -e "$line" | sed 's/\x1b\[[0-9;]*m//g')
    cetak "$clean_line"
  done

  echo
}

# ==== âš™ï¸ CEK DEPENDENSI
install_dependencies() {
  cetak "[âš™ï¸] Cek dan install dependensi..."
  pkg update -y 2>/dev/null | print_output
  pkg upgrade -y 2>/dev/null | print_output
  pkg_install nodejs git
  cd "$PROJECT_DIR" || exit
  cetak "[ğŸ“] Cek folder node_modules..."
  if [ ! -d "node_modules" ]; then
    cetak "[ğŸ“¦] node_modules belum ada. Jalankan npm install..."
    npm install | print_output
  else
    cetak "[âœ…] node_modules sudah tersedia"
  fi
}

# ==== ğŸš€ JALANKAN BACKEND
start_backend() {
  echo
  cetak "[ğŸš€] Menjalankan server WhatsApp..."
  echo
  cd "$PROJECT_DIR" || exit
  while true; do
    node index.js
    cetak "[ğŸ’¥] Server mati. Restarting dalam 3 detik..."
    sleep 3
  done
}

# ==== ğŸ” INSTALL KE $PREFIX/bin
install_command() {
  if [ ! -f "$SCRIPT_PATH" ]; then
    cetak "[ğŸ› ï¸] Menambahkan shortcut 'sanin' ke \$PREFIX/bin"
    cp "$0" "$SCRIPT_PATH"
    sed -i 's/\r$//' "$SCRIPT_PATH"
    chmod +x "$SCRIPT_PATH"
    cetak "[âœ…] Sekarang bisa ketik 'sanin' dari mana aja"
    echo
  fi
}

# ==== ğŸ”„ MODE UPDATE
if [[ $1 == "update" ]]; then
  cetak "[ğŸ”„] Update script sanin dari GitHub..."
  curl -L -o "$SCRIPT_PATH" "$GITHUB_URL" | print_output
  sed -i 's/\r$//' "$SCRIPT_PATH"
  chmod +x "$SCRIPT_PATH"
  cetak "[âœ…] Script berhasil diupdate!"
  exit
fi

# ==== ğŸ§  EKSEKUSI
ascii_art
show_banner
install_command
install_dependencies
start_backend
