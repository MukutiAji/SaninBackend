#!/data/data/com.termux/files/usr/bin/bash

PROJECT_DIR="$HOME/sanin-backend"
GITHUB_URL="https://raw.githubusercontent.com/MukutiAji/SaninBackend/main/sanin"

# ==== ğŸ”„ MODE UPDATE
if [[ $1 == "update" ]]; then
    echo "[ğŸ”„] Update script sanin dari GitHub..." | lolcat
    curl -L -o "$PREFIX/bin/sanin" "$GITHUB_URL"
    sed -i 's/\r$//' "$PREFIX/bin/sanin"
    chmod +x "$PREFIX/bin/sanin"
    echo "[âœ…] Script berhasil diupdate!" | lolcat
    exit
fi

# ==== ğŸ“¦ INSTALL PAKAI NALA JIKA ADA
function pkg_install() {
    if command -v nala &>/dev/null; then
        echo "[ğŸ“¦] Menggunakan nala..." | lolcat
        for pkg in "$@"; do
            if ! dpkg -s $pkg &>/dev/null; then
                nala install -y $pkg
            else
                echo "[âœ…] $pkg sudah terinstall"
            fi
        done
    else
        for pkg in "$@"; do
            if ! command -v $pkg &>/dev/null; then
                pkg install $pkg -y
            else
                echo "[âœ…] $pkg sudah terinstall"
            fi
        done
    fi
}

# ==== ğŸ¨ LOGO
function show_banner() {
    clear
    pkg_install figlet lolcat boxes

    figlet SANIN WA | lolcat
    echo "By: Mukticuy" | boxes -d parchment | lolcat
    echo
}

# ==== ğŸ§° CEK DEPENDENSI
function install_dependencies() {
    echo "[âš™ï¸] Cek dan install dependensi..." | lolcat
    pkg update -y && pkg upgrade -y

    pkg_install nodejs git

    cd "$PROJECT_DIR" || exit

    echo "[ğŸ“] Cek folder node_modules..." | lolcat
    if [ ! -d "node_modules" ]; then
        echo "[ğŸ“¦] node_modules belum ada. Jalankan npm install..." | lolcat
        npm install
    else
        echo "[âœ…] node_modules sudah tersedia" | lolcat
    fi
}

# ==== ğŸš€ JALANKAN BACKEND
function start_backend() {
    echo
    echo "[ğŸš€] Menjalankan server WhatsApp..." | boxes -d peek | lolcat
    echo
    cd "$PROJECT_DIR" || exit
    while true; do
        node index.js
        echo "[ğŸ’¥] Server mati. Restarting dalam 3 detik..." | lolcat
        sleep 3
    done
}

# ==== ğŸ” INSTALL KE $PREFIX/bin
function install_command() {
    SCRIPT_PATH="$PREFIX/bin/sanin"
    if [ ! -f "$SCRIPT_PATH" ]; then
        echo "[ğŸ› ï¸] Menambahkan shortcut 'sanin' ke \$PREFIX/bin" | lolcat
        cp "$0" "$SCRIPT_PATH"
        sed -i 's/\r$//' "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
        echo "[âœ…] Sekarang bisa ketik 'sanin' dari mana aja" | lolcat
        echo
    fi
}

# ==== ğŸ§  MAIN EKSEKUSI
show_banner
install_command
install_dependencies
start_backend
