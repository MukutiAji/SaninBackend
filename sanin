#!/data/data/com.termux/files/usr/bin/bash

PROJECT_DIR="$HOME/sanin-backend"
GITHUB_URL="https://raw.githubusercontent.com/MukutiAji/SaninBackend/main/sanin"
SCRIPT_PATH="$PREFIX/bin/sanin"

# ==== 🎨 WARNA RANDOM CERAH
COLORS=(32 33 34 35 36 91 92 93 94 95 96) # hijau kuning biru pink cyan dll
RANDOM_COLOR=${COLORS[$RANDOM % ${#COLORS[@]}]}

# Fungsi cetak berwarna
cetak() {
  echo -e "\e[1;${RANDOM_COLOR}m$1\e[0m"
}

# ==== 🎭 ASCII ART OPENING
function ascii_art() {
  clear
  cetak "╭━━━┳━━━┳━╮╱╭┳━━┳━╮╱╭╮"
  cetak "┃╭━╮┃╭━╮┃┃╰╮┃┣┫┣┫┃╰╮┃┃"
  cetak "┃╰━━┫┃╱┃┃╭╮╰╯┃┃┃┃╭╮╰╯┃"
  cetak "╰━━╮┃╰━╯┃┃╰╮┃┃┃┃┃┃╰╮┃┃"
  cetak "┃╰━╯┃╭━╮┃┃╱┃┃┣┫┣┫┃╱┃┃┃"
  cetak "╰━━━┻╯╱╰┻╯╱╰━┻━━┻╯╱╰━╯"
  sleep 2
}

# ==== 📦 CEK & INSTALL PAKET
function pkg_install() {
  if command -v nala &>/dev/null; then
    cetak "[📦] Menggunakan nala..."
    for pkg in "$@"; do
      if ! dpkg -s $pkg &>/dev/null; then
        nala install -y $pkg
      else
        cetak "[✅] $pkg sudah terinstall"
      fi
    done
  else
    for pkg in "$@"; do
      if ! command -v $pkg &>/dev/null; then
        pkg install $pkg -y
      else
        cetak "[✅] $pkg sudah terinstall"
      fi
    done
  fi
}

# ==== 🎨 BANNER SANIN
function show_banner() {
  clear
  pkg_install figlet boxes
  echo
  figlet -w 100 SANIN WA | while IFS= read -r line; do cetak "$line"; done
  echo "By: Mukticuy" | boxes -d stone | while IFS= read -r line; do cetak "$line"; done
  echo
}

# ==== ⚙️ CEK DEPENDENSI
function install_dependencies() {
  cetak "[⚙️] Cek dan install dependensi..."
  pkg update -y && pkg upgrade -y
  pkg_install nodejs git
  cd "$PROJECT_DIR" || exit
  cetak "[📁] Cek folder node_modules..."
  if [ ! -d "node_modules" ]; then
    cetak "[📦] node_modules belum ada. Jalankan npm install..."
    npm install
  else
    cetak "[✅] node_modules sudah tersedia"
  fi
}

# ==== 🚀 JALANKAN BACKEND
function start_backend() {
  echo
  cetak "[🚀] Menjalankan server WhatsApp..."
  echo
  cd "$PROJECT_DIR" || exit
  while true; do
    node index.js
    cetak "[💥] Server mati. Restarting dalam 3 detik..."
    sleep 3
  done
}

# ==== 🔁 INSTALL KE $PREFIX/bin
function install_command() {
  if [ ! -f "$SCRIPT_PATH" ]; then
    cetak "[🛠️] Menambahkan shortcut 'sanin' ke \$PREFIX/bin"
    cp "$0" "$SCRIPT_PATH"
    sed -i 's/\r$//' "$SCRIPT_PATH"
    chmod +x "$SCRIPT_PATH"
    cetak "[✅] Sekarang bisa ketik 'sanin' dari mana aja"
    echo
  fi
}

# ==== 🔄 MODE UPDATE
if [[ $1 == "update" ]]; then
  cetak "[🔄] Update script sanin dari GitHub..."
  curl -L -o "$SCRIPT_PATH" "$GITHUB_URL"
  sed -i 's/\r$//' "$SCRIPT_PATH"
  chmod +x "$SCRIPT_PATH"
  cetak "[✅] Script berhasil diupdate!"
  exit
fi

# ==== 🧠 EKSEKUSI
ascii_art
show_banner
install_command
install_dependencies
start_backend
